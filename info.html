<!doctype html>
<html>
	<head>
		<title>BOTW Cooking Simulator</title>
		<link rel='icon' href='img/food/apple.png'/>
		<link rel='stylesheet' href='style/main.css'/>
		<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
	</head>
	<body>
		<div id='wrapper'>
			<header>
				Zelda Breath of The Wild: Cooking Simulator	
			</header>

			<nav>
				<ul class='navbar'>
					<li class='navbar-item'><a href='index.html'>Cook</a></li>
					<li class='navbar-item'><a href='learn.html'>Learn</a></li>
					<li class='navbar-item'><a href='recipe.html'>Recipes</a></li>
				</ul>
			</nav>

			<div class='dish-lg'>
				<div class='dishHeader'>
					<span class='dishImage'></span>
					<span class='dishTitle'></span>
				</div>
				<div class='dishDesc'></div>
				<div id='dishType'></div>
				<div id='dishEffect'></div>
				<table id='dishStats'>
					<thead>
						<tr>
							<th>Times repeated</th>
							<th>1</th>
							<th>2</th>
							<th>3</th>
							<th>4</th>
							<th>5</th>
						</tr>
					</thead>
					<tbody>
						<tr id='dishHearts'></tr>
						<tr id='dishDuration'></tr>
						<tr id='dishLevel'></tr>
					</tbody>
				</table>
				<div id='dishRelated'></div>
			</div>
		</div>

		<script src='util.js'></script>
		<script>
			var items = [],
				dishes = [];

			/* DOM Vars */
			var dish = document.getElementsByClassName('dish-lg')[0]
				, dishImage = document.getElementsByClassName('dishImage')[0]
				, dishTitle = document.getElementsByClassName('dishTitle')[0]
				, dishDesc = document.getElementsByClassName('dishDesc')[0]
				, dishType = document.getElementById('dishType')
				, dishEffect = document.getElementById('dishEffect')
				, dishHearts = document.getElementById('dishHearts')
				, dishRelated = document.getElementById('dishRelated');

			/* Get the food.json file using the Fetch API */
			if (self.fetch) {
				fetchThen('food.json', function(data) {
					var id = getParam("id");

					items = data;
					if (id) {
						if (id < 0 || id >= items.length)
							dish.innerHTML = "Out of bounds ID : " + id;
						else {
							fetchThen('recipes.json', function(data) {
								dishes = data;
								debug && console.log("Dishes loaded");
								UIdisplayIngredientInfo(items[id]);
							});
						}
					} else {
						dish.innerHTML = "Missing ID ! Request this page with the GET method and 'id' argument.";
					}
				});
			} else {
				console.log("Your browser is outdated and does not support the Fetch API.");
			}

			function UIdisplayIngredientInfo(ing) {
				var effectTransform;

				if (!ing) return ;
				effectTransform = getEffectTransform(ing.effect);

				dishImage.innerHTML = '<img src="img/food/' + ing.image + '"/>';
				dishTitle.innerHTML = ing.name;
				setType(ing);
				dishEffect.innerHTML = 'Effect: ' + htmlEffect(ing) + ' ' + ing.effect;
				dishDesc.innerHTML = ing.description || 'No description.';
				setRow(dishHearts, "Hearts Healed", ing.hearts, htmlHearts);
				setRow(dishDuration, getEffectDescription(ing.effect), ing.duration, effectTransform); 
				// Only display effect level if it's a regular one (timed)
				if (hasRegularEffect(ing))
					setRow(dishLevel, "Effect Level", ing.level, null);
				setRelated(ing);
			}

			function setType(ing) {
				dishType.appendChild(myCreateElement("h3", {
					innerHTML: 'Type Tree:'
				}));
				for (var i = 0; i < ing.type.length; i++) {
					dishType.appendChild(myCreateElement("div", {
						innerHTML: Array(i + 1).join('-') + '> ' + htmlType(ing.type[i]) + (i == 0 ? ' (parent type)' : '')
					}));
				}
			}

			/*
			 * Fills a given row (DOM) from 'table' the data in the array 'data'
			 * If 'transformFunction' is given, applies it to every member of 'data' before displaying it.
			 * Removes any data that was previously on this row
			 */
			function setRow(row, title, data, transformFunction) {
				while (row.firstChild) {
					row.removeChild(row.firstChild);
				}
				row.appendChild(myCreateElement("td", {innerHTML: title}));
				for (var i = 0; i < data.length; i++) {
					row.appendChild(myCreateElement("td", {
						innerHTML: transformFunction ? transformFunction(data[i]) : data[i]
					}));
				}
			}

			function setRelated(ing) {
				var recipes = getRelatedRecipes(dishes, ing);

				if (recipes.length == 0) {
					dishRelated.appendChild(myCreateElement("h3", {
						innerHTML: 'No known recipe uses this ingredient.'
					}));
				} else {
					dishRelated.appendChild(myCreateElement("h3", {
						innerHTML: 'Appears in ' + recipes.length + ' recipes:'
					}));
					recipes.sort(compareByName);
					for (var i = 0; i < recipes.length; i++) { // Loop every recipe in subtype => apple: Apple pie, ... ; any: simmered fruit, mushroom mix, ...
						dishRelated.appendChild(myCreateElement("div", {
							className: 'dish-sm',
							innerHTML: 	'<div class="dishHeader">' +
											'<span class="dishImage">' +
												'<img src="img/food/' + recipes[i].image + '"/>' +
											'</span>' + '<span class="dishTitle">' +
												recipes[i].name +
											'</span>' +
										'</div>' +
										'<div class="dishDesc">' +
											'<strong>Recipe</strong>: ' + recipes[i].required.map(function(item) { return htmlType(item); }).join(' + ') +
												(recipes[i].excluded ? ' (except: ' + recipes[i].excluded.join(', ') + ')' : '') +
										'</div>'
						}));
					}
				}
			}
		</script>
	</body>
</html>